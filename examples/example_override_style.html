<html>

<head>
  <link rel="stylesheet" href="../assets/stylesheets/style.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    #holder
    {
      width: 100%;
      height: 75%;
    }

    #load
    {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
    }

    p
    {
      color: white;
    }
  </style>

  <script src="../src/waveslab.js"></script>
</head>

<body class="theme">
  <div class="flex-box" style="height: 40%; margin-top: 5%">
    <div class="flex-item" style="flex: 30%">
      <div class="card card-solid">
        <table class="waveslab-table">
          <tr>
            <td></td>
            <td>Title</td>
            <td>Artist</td>
            <td class="material-icons">schedule</td>
          </tr>
          <tr onClick="selectSong(this, '../assets/audios/dubstep.mp3');">
            <td class="material-icons">favorite</td>
            <td>Dubstep</td>
            <td>BenSound</td>
            <td>2:04</td>
          </tr>
          <tr onClick="selectSong(this, '../assets/audios/betterdays.mp3');">
            <td class="material-icons">favorite</td>
            <td>Better Days</td>
            <td>BenSound</td>
            <td>2:34</td>
          </tr>
          <tr onClick="selectSong(this, '../assets/audios/slowmotion.mp3');" class="selected">
            <td class="material-icons">favorite</td>
            <td>Slow Motion</td>
            <td>BenSound</td>
            <td>3:26</td>
          </tr>
          <tr onClick="selectSong(this, '../assets/audios/veloma.mp3');">
            <td class="material-icons">favorite</td>
            <td>Veloma</td>
            <td>Fabrizio Paterlin</td>
            <td>2:54</td>
          </tr>
        </table>
      </div>
    </div>
    <div class="flex-item" style="flex: 65%;">
      <div class="card card-solid">
        <div id="holder"></div>
        <button id="btn" class="material-icons btn-square" type="button" onclick="wave.playPause()" disabled>play_arrow</button>
      </div>
    </div>
    <div class="flex-item" style="flex: 90%;">
      <div class="card card-outline" style="align-items: center; display: flex; justify-content: center;">
        <svg class="progress-ring" style="vertical-align: middle;" width="120" height="120">
          <circle class="progress-ring__circle" stroke-width="4" fill="transparent" r="52" cx="60" cy="60" />
          <text id="progress-ring-text" x="50%" y="50%" text-anchor="middle" fill="white" font-size="20px" font-family="Arial" dy=".3em">00:00</text>
        </svg>
      </div>
    </div>
  </div>

  <script>
    var isPlay = true;

    // Create the chart.
    var wave = new FrequencyChart(
    {
      container: "holder",
      fftSize: 13
    });

    //overriding setBarStyle for advanced users
    wave.drawBars = function(currentX, barWidth, barHeight, amplitude, ctx, ctxHeight)
    {
      //top bars
      ctx.fillStyle = 'rgb(50,' + (currentX) + ',' + (barHeight + 100) + ')';
      ctx.fillRect(currentX, ctxHeight / 2 - barHeight * amplitude, barWidth, barHeight * amplitude);

      //bottom reflected bars
      ctx.fillStyle = 'rgba(50,' + (currentX) + ',' + (barHeight + 100) + ', 0.3)';
      ctx.fillRect(currentX, ctxHeight / 2, barWidth, barHeight / 5);
    }

    // Kick everything off with the provided audio file.
    wave.generate("../assets/audios/slowmotion.mp3");

    // Function to select a song from the table.
    function selectSong(ele, song)
    {
      // Set the selected song row.
      var elems = document.querySelectorAll('.waveslab-table tr');
      for (let i = 0; i < elems.length; i++)
      {
        elems[i].classList.remove('selected');
      }
      ele.classList.add('selected');
      document.getElementById("btn").disabled = true;

      // Generate the new frequency data.
      wave.stop();
      wave.generate(song);
    }

    // This event is used to indicate the audio has completed the loading process.
    document.addEventListener("WaveSlab:AudioLoadComplete", function(event)
    {
      document.getElementById("btn").disabled = false;
    });

    document.addEventListener("WaveSlab:PlayEvent", function(event)
    {
      document.getElementById("btn").textContent = "pause";
    });

    document.addEventListener("WaveSlab:StopEvent", function(event)
    {
      document.getElementById("btn").textContent = "play_arrow";
    });

    // Progress ring related logic.
    var circle = document.querySelector('circle');
    var radius = circle.r.baseVal.value;
    var circumference = radius * 2 * Math.PI;
    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = `${circumference}`;

    function setProgress(percent)
    {
      const offset = circumference - percent / 100 * circumference;
      circle.style.strokeDashoffset = offset;
    }

    document.addEventListener("WaveSlab:PlaybackTimeStatus", function(event)
    {
      setProgress(event.detail.timeSeconds / wave.duration * 100);
      var timestamp = parseFloat(event.detail.timeSeconds);
      document.getElementById("progress-ring-text").textContent = timestamp.toFixed(2);
    });
  </script>
</body>
